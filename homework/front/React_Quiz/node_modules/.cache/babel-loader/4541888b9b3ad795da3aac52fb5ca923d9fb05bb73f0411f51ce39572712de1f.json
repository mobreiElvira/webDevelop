{"ast":null,"code":"import * as React from 'react';\nimport { useInsertionEffect } from 'react';\nimport { pathKey } from \"../Cache\";\nimport StyleContext from \"../StyleContext\";\nimport useHMR from \"./useHMR\";\nconst effectMap = new Map();\nexport default function useGlobalCache(prefix, keyPath, cacheFn, onCacheRemove,\n// Add additional effect trigger by `useInsertionEffect`\nonCacheEffect) {\n  const {\n    cache: globalCache\n  } = React.useContext(StyleContext);\n  const fullPath = [prefix, ...keyPath];\n  const fullPathStr = pathKey(fullPath);\n  const HMRUpdate = useHMR();\n  const buildCache = updater => {\n    globalCache.opUpdate(fullPathStr, prevCache => {\n      const [times = 0, cache] = prevCache || [undefined, undefined];\n\n      // HMR should always ignore cache since developer may change it\n      let tmpCache = cache;\n      if (process.env.NODE_ENV !== 'production' && cache && HMRUpdate) {\n        onCacheRemove === null || onCacheRemove === void 0 || onCacheRemove(tmpCache, HMRUpdate);\n        tmpCache = null;\n      }\n      const mergedCache = tmpCache || cacheFn();\n      const data = [times, mergedCache];\n\n      // Call updater if need additional logic\n      return updater ? updater(data) : data;\n    });\n  };\n\n  // Create cache\n  React.useMemo(() => {\n    buildCache();\n  }, /* eslint-disable react-hooks/exhaustive-deps */\n  [fullPathStr]\n  /* eslint-enable */);\n  let cacheEntity = globalCache.opGet(fullPathStr);\n\n  // HMR clean the cache but not trigger `useMemo` again\n  // Let's fallback of this\n  // ref https://github.com/ant-design/cssinjs/issues/127\n  if (process.env.NODE_ENV !== 'production' && !cacheEntity) {\n    buildCache();\n    cacheEntity = globalCache.opGet(fullPathStr);\n  }\n  const cacheContent = cacheEntity[1];\n\n  // Remove if no need anymore\n  useInsertionEffect(() => {\n    buildCache(_ref => {\n      let [times, cache] = _ref;\n      return [times + 1, cache];\n    });\n    if (!effectMap.has(fullPathStr)) {\n      onCacheEffect === null || onCacheEffect === void 0 || onCacheEffect(cacheContent);\n      effectMap.set(fullPathStr, true);\n\n      // 微任务清理混存，可以认为是单次 batch render 中只触发一次 effect\n      Promise.resolve().then(() => {\n        effectMap.delete(fullPathStr);\n      });\n    }\n    return () => {\n      globalCache.opUpdate(fullPathStr, prevCache => {\n        const [times = 0, cache] = prevCache || [];\n        const nextCount = times - 1;\n        if (nextCount === 0) {\n          onCacheRemove === null || onCacheRemove === void 0 || onCacheRemove(cache, false);\n          effectMap.delete(fullPathStr);\n          return null;\n        }\n        return [times - 1, cache];\n      });\n    };\n  }, [fullPathStr]);\n  return cacheContent;\n}","map":{"version":3,"names":["React","useInsertionEffect","pathKey","StyleContext","useHMR","effectMap","Map","useGlobalCache","prefix","keyPath","cacheFn","onCacheRemove","onCacheEffect","cache","globalCache","useContext","fullPath","fullPathStr","HMRUpdate","buildCache","updater","opUpdate","prevCache","times","undefined","tmpCache","process","env","NODE_ENV","mergedCache","data","useMemo","cacheEntity","opGet","cacheContent","_ref","has","set","Promise","resolve","then","delete","nextCount"],"sources":["F:/综合/个人/作业/主课/大三/web开发/homework/front/React_Quiz/node_modules/@ant-design/cssinjs/es/hooks/useGlobalCache.js"],"sourcesContent":["import * as React from 'react';\nimport { useInsertionEffect } from 'react';\nimport { pathKey } from \"../Cache\";\nimport StyleContext from \"../StyleContext\";\nimport useHMR from \"./useHMR\";\nconst effectMap = new Map();\nexport default function useGlobalCache(prefix, keyPath, cacheFn, onCacheRemove,\n// Add additional effect trigger by `useInsertionEffect`\nonCacheEffect) {\n  const {\n    cache: globalCache\n  } = React.useContext(StyleContext);\n  const fullPath = [prefix, ...keyPath];\n  const fullPathStr = pathKey(fullPath);\n  const HMRUpdate = useHMR();\n  const buildCache = updater => {\n    globalCache.opUpdate(fullPathStr, prevCache => {\n      const [times = 0, cache] = prevCache || [undefined, undefined];\n\n      // HMR should always ignore cache since developer may change it\n      let tmpCache = cache;\n      if (process.env.NODE_ENV !== 'production' && cache && HMRUpdate) {\n        onCacheRemove?.(tmpCache, HMRUpdate);\n        tmpCache = null;\n      }\n      const mergedCache = tmpCache || cacheFn();\n      const data = [times, mergedCache];\n\n      // Call updater if need additional logic\n      return updater ? updater(data) : data;\n    });\n  };\n\n  // Create cache\n  React.useMemo(() => {\n    buildCache();\n  }, /* eslint-disable react-hooks/exhaustive-deps */\n  [fullPathStr]\n  /* eslint-enable */);\n  let cacheEntity = globalCache.opGet(fullPathStr);\n\n  // HMR clean the cache but not trigger `useMemo` again\n  // Let's fallback of this\n  // ref https://github.com/ant-design/cssinjs/issues/127\n  if (process.env.NODE_ENV !== 'production' && !cacheEntity) {\n    buildCache();\n    cacheEntity = globalCache.opGet(fullPathStr);\n  }\n  const cacheContent = cacheEntity[1];\n\n  // Remove if no need anymore\n  useInsertionEffect(() => {\n    buildCache(([times, cache]) => [times + 1, cache]);\n    if (!effectMap.has(fullPathStr)) {\n      onCacheEffect?.(cacheContent);\n      effectMap.set(fullPathStr, true);\n\n      // 微任务清理混存，可以认为是单次 batch render 中只触发一次 effect\n      Promise.resolve().then(() => {\n        effectMap.delete(fullPathStr);\n      });\n    }\n    return () => {\n      globalCache.opUpdate(fullPathStr, prevCache => {\n        const [times = 0, cache] = prevCache || [];\n        const nextCount = times - 1;\n        if (nextCount === 0) {\n          onCacheRemove?.(cache, false);\n          effectMap.delete(fullPathStr);\n          return null;\n        }\n        return [times - 1, cache];\n      });\n    };\n  }, [fullPathStr]);\n  return cacheContent;\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}